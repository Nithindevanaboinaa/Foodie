<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart</title>
    <link rel="stylesheet" href="/static/css/cart.css">
    <link rel="stylesheet" href="/static/css/Home.css">
</head>
<body>
    <header>
        <div class="main-header">
            <div class="logo">
                <h1><a href="{{url_for('home')}}"><img src="/static/foodlogo.gif"></a></h1>
            </div>
            <nav>
                <ul>
                    <li><a href="{{url_for('home')}}">Home</a></li>
                    <li><a href="{{url_for('show_menu')}}">Menu</a></li>
                    <li><a href="{{url_for('reservation')}}">Reservation</a></li>
                    <li><a href="#contact">Contact us</a></li>
                    <li><a href="#about">About us</a></li>
                    <li><a href="{{url_for('cart')}}" id="cart-icon"><img src="/static/shopping-cart.gif"></a></li>
                    <li>
                        <a href="{{ url_for('logout') }}"><input type="button" value="Logout"/></a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="full">
            <div class="left">
                <form id="address-form" action="{{url_for('address')}}" method="POST">
                    <label for="address">Address:</label>
                    <input type="text" id="address" name="address" required>
                    <label for="dno">Dno/Flat No:</label>
                    <input type="text" id="dno" name="dno" required>
                    <label for="landmark">Landmark:</label>
                    <input type="text" id="landmark" name="landmark" required>
                    <button type="submit">Save</button>
                </form>
                <div id="payment-options">
                    <label><input type="radio" name="payment" value="cod" required> Cash on Delivery</label>
                    <label><input type="radio" name="payment" value="online" required> Online Payment</label>
                </div>
                <div><button type="button" onclick="proceedToPayment()">Proceed</button></div>
            </div>
            <div class="right">
                <h2>Your Cart</h2>
                <div id="cart-items"></div>
                <p id="total-price"></p> <!-- Display total price here -->
                <button onclick="clearCart()">Clear Cart</button>
            </div>
        </div>
    </main>
    
    <div id="snackbar">Item removed from cart</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            updateCart();
        });

        function updateCart() {
            fetch('/fetch_cart')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const cart = data.cart;
                        renderCart(cart);
                    } else {
                        alert('Failed to load cart data');
                    }
                });
        }

        function renderCart(cart) {
            const cartItemsContainer = document.getElementById('cart-items');
            const totalPriceElement = document.getElementById('total-price');
            cartItemsContainer.innerHTML = '';
            let totalPrice = 0;

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p>Your cart is empty</p>';
                totalPriceElement.textContent = '';  // Clear total price if cart is empty
            } else {
                cart.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'cart-item';
                    itemElement.innerHTML = `
                        <h3>${item.name}</h3>
                        <p>Quantity: ${item.quantity}</p>
                        <p>Price: ₹${item.price}</p>
                        <button onclick="deleteCartItem('${item.name}')">Remove</button>
                    `;
                    cartItemsContainer.appendChild(itemElement);
                    totalPrice += item.price * item.quantity;  // Calculate total price
                });
                totalPriceElement.textContent = `Total Price: ₹${totalPrice}`;  // Display total price
            }
            updateCartCount();
        }

        function deleteCartItem(name) {
            fetch('/remove_cart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: name })  // Send the name of the item to remove
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateCart();  // Update the cart display after successful removal
                    showSnackbar('Item removed from cart');
                } else {
                    alert(data.message);  // Show error message if removal failed
                }
            })
            .catch(error => {
                console.error('Error removing item:', error);
                alert('An error occurred while removing the item.');
            });
        }

        function clearCart() {
            fetch('/clear_cart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify([])
            }).then(() => updateCart());
        }

        function proceedToPayment() {
            const paymentOption = document.querySelector('input[name="payment"]:checked');
            if (!paymentOption) {
                alert('Please select a payment option');
                return;
            }

            fetch('/process_payment', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSnackbar();
                }
            });
        }

        function showSnackbar() {
            const snackbar = document.getElementById('snackbar');
            snackbar.className = 'show';
            setTimeout(() => { snackbar.className = snackbar.className.replace('show', ''); }, 3000);
        }

        document.getElementById('cart-icon').addEventListener('click', () => {
            window.location.href = '{{url_for('cart')}}';
        });
    </script>
</body>
</html>
